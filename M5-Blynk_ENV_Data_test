#include <BlynkSimpleEsp32.h>
#include <M5Stack.h>
#include <WiFi.h>
#include <WiFiClient.h>

//stuff for env sensors
#include "M5_ENV.h"
SHT3X sht30;
QMP6988 qmp6988;
float tmp      = 0.0;
float hum      = 0.0;
float pressure = 0.0;

// You should get Auth Token in the Blynk App.
// Go to the Project Settings (nut icon). 
//85% of the stuff below is specific to my account on Blynk IoT service, so it probably won't work for anyone other than myself (hence why I sent a video of my results in teams
char auth[] = "DwKvcJcqXpdIGVO8JrfoIHxz6LJ2Gl58";
char ssid[] = "ssid_blank_for_security_reasons";
char pass[] = "password_blank_for_security_reasons";

BlynkTimer timer;



void myTimerEvent() {
    // Blynk.virtualWrite(V9, millis() / 1000)
    if (sht30.get() == 0) {  
        tmp = sht30.cTemp;                      
        hum = sht30.humidity;  
        
                               
    } else {
        tmp = 0, hum = 0;
    }

    Blynk.virtualWrite(V0, tmp);
    Blynk.virtualWrite(V1, hum);
    Blynk.virtualWrite(V2, pressure);   //ignore this for now, doesn't do anything as any attempts I make to display pressure in Blynk breaks everything else
    M5.Lcd.setCursor(0, 0);
    M5.Lcd.setTextColor(WHITE, BLACK);
    M5.Lcd.setTextSize(2);
    M5.Lcd.printf("Temperature:%2.1fC  \r\nHumidity:%2.1f%%  \r\nPressure:%2.0fhPa", tmp, hum);
}

void setup() {
    // Debug console
    M5.begin();
    M5.Power.begin();

    // Blynk start
    Blynk.begin(auth, ssid, pass, "blynk.cloud");

    // Setup a function to be called every second
    timer.setInterval(2000L, myTimerEvent);
    M5.Lcd.setBrightness(10);
}

void loop() {
    Blynk.run();
    timer.run();  // Initiates BlynkTimer
}
